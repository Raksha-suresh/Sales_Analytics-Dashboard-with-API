<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sales Analytics Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .kpis { display:flex; gap:20px; margin-bottom:20px; }
    .kpi { padding:15px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); min-width:150px; }
    .charts { display:flex; gap:20px; }
    .chart-card { flex:1; padding:10px; }
  </style>
</head>
<body>
  <h1>Sales Analytics Dashboard</h1>
  <div class="kpis">
    <div class="kpi"><h3>Total Revenue</h3><div id="kpi-revenue">-</div></div>
    <div class="kpi"><h3>Total Orders</h3><div id="kpi-orders">-</div></div>
    <div class="kpi"><h3>Avg Order Value</h3><div id="kpi-aov">-</div></div>
  </div>

  <div>
    <label>Start date: <input type="date" id="start-date"></label>
    <label>End date: <input type="date" id="end-date"></label>
    <button onclick="loadAll()">Apply</button>
  </div>

  <div class="charts" style="margin-top:20px;">
    <div class="chart-card">
      <h3>Daily Revenue</h3>
      <canvas id="dailyChart"></canvas>
    </div>
    <div class="chart-card">
      <h3>Top Products</h3>
      <canvas id="topProductsChart"></canvas>
    </div>
  </div>

  <script>
    async function fetchJson(url){
      const res = await fetch(url);
      return res.json();
    }

    async function loadKPIs(start, end){
      let url = '/api/sales/summary';
      const params = new URLSearchParams();
      if(start) params.set('start_date', start);
      if(end) params.set('end_date', end);
      if(Array.from(params).length) url += '?' + params.toString();
      const data = await fetchJson(url);
      document.getElementById('kpi-revenue').innerText = '$' + data.total_revenue.toFixed(2);
      document.getElementById('kpi-orders').innerText = data.total_orders;
      document.getElementById('kpi-aov').innerText = '$' + data.avg_order_value.toFixed(2);
    }

    let dailyChart=null, topProductsChart=null;

    async function loadDaily(start, end){
      let url = '/api/sales/daily';
      const params = new URLSearchParams();
      if(start) params.set('start_date', start);
      if(end) params.set('end_date', end);
      if(Array.from(params).length) url += '?' + params.toString();
      const data = await fetchJson(url);
      const labels = data.map(d => d.date);
      const values = data.map(d => d.revenue);
      const ctx = document.getElementById('dailyChart').getContext('2d');
      if(dailyChart) dailyChart.destroy();
      dailyChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Revenue', data: values, fill: false }] },
        options: {}
      });
    }

    async function loadTopProducts(start, end){
      let url = '/api/sales/top-products?n=5';
      const params = new URLSearchParams();
      if(start) params.set('start_date', start);
      if(end) params.set('end_date', end);
      if(Array.from(params).length) url += '&' + params.toString();
      const data = await fetchJson(url);
      const labels = data.map(d => d.product);
      const values = data.map(d => d.revenue);
      const ctx = document.getElementById('topProductsChart').getContext('2d');
      if(topProductsChart) topProductsChart.destroy();
      topProductsChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Revenue', data: values }] },
        options: {}
      });
    }

    async function loadAll(){
      const start = document.getElementById('start-date').value || null;
      const end = document.getElementById('end-date').value || null;
      await loadKPIs(start, end);
      await loadDaily(start, end);
      await loadTopProducts(start, end);
    }

    // initial load
    loadAll();
  </script>
</body>
</html>
